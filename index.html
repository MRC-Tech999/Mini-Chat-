<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Temporary Email ‚Äì MARC‚ÄëTech</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family: Arial, sans-serif; background:#f4f4f4; color:#333; padding:20px }
    .container { max-width:600px; margin:0 auto }
    h1,h2 { margin-bottom:10px }
    section { background:#fff; padding:15px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:20px }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .row p { flex:1; word-break:break-all }
    input, textarea, button { width:100%; padding:10px; margin-top:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px }
    button { background:#007bff; color:#fff; border:none; cursor:pointer; transition:background .2s }
    button:disabled { opacity:.6; cursor:not-allowed }
    button:hover:not(:disabled) { background:#0056b3 }
    .message { padding:12px; border:1px solid #ddd; border-radius:6px; margin-bottom:12px; box-shadow:0 1px 4px rgba(0,0,0,0.05) }
    .message p { margin-bottom:8px }
    .message button { width:auto; padding:6px 12px; font-size:.9rem }
    #sendStatus { color:#007bff; margin-top:8px }
    .footer { text-align:center; font-size:.85rem; color:#777; margin-top:40px }
  </style>
</head>
<body>
  <div class="container">
    <h1>Temp Mail (via Marc‚ÄëTech)</h1>

    <!-- 1. G√©n√©ration & copie -->
    <section>
      <h2>1. G√©n√©rer & copier une adresse jetable</h2>
      <div class="row">
        <p><strong id="emailDisplay">‚Äî</strong></p>
        <button id="btn-generate">G√©n√©rer</button>
        <button id="btn-copy" disabled>Copier</button>
      </div>
    </section>

    <!-- 2. Messages re√ßus -->
    <section>
      <h2>2. Messages re√ßus</h2>
      <div id="messages">
        <p>Aucun message pour l‚Äôinstant.</p>
      </div>
    </section>

    <!-- 3. Envoi d'un e‚Äëmail -->
    <section>
      <h2>3. Envoyer un e‚Äëmail depuis l‚Äôadresse jetable</h2>
      <label for="fromEmail">De (MailSAC) :</label>
      <input type="email" id="fromEmail" readonly>

      <label for="toEmail">√Ä :</label>
      <input type="email" id="toEmail" placeholder="destinataire@exemple.com">

      <label for="subject">Sujet :</label>
      <input type="text" id="subject" placeholder="Sujet du message">

      <label for="body">Message :</label>
      <textarea id="body" rows="4" placeholder="Votre message‚Ä¶"></textarea>

      <button id="btn-send" disabled>Envoyer</button>
      <p id="sendStatus"></p>
    </section>

    <div class="footer">
      &copy; Marc‚ÄëTech 2025
    </div>
  </div>

  <script>
  (function(){
    // === CONFIGURATION ===
    const MAILSAC_KEY      = 'k_SlFHIkRTITLDKtpxYoQ8JX0ua9pnKIyBgQ0537';
    const MAILSAC_DOMAIN   = 'mailsac.com';
    const MAIL_SENDER_HOST = 'mail-sender-api1.p.rapidapi.com';
    const MAIL_SENDER_KEY  = 'ab42dda446mshde4ba65d25b85fdp13b83ejsn3965c0519b7d';

    // === DOM ===
    const emailDisplay = document.getElementById('emailDisplay');
    const btnGen       = document.getElementById('btn-generate');
    const btnCopy      = document.getElementById('btn-copy');
    const messagesDiv  = document.getElementById('messages');

    const fromInput    = document.getElementById('fromEmail');
    const toInput      = document.getElementById('toEmail');
    const subjectInput = document.getElementById('subject');
    const bodyInput    = document.getElementById('body');
    const btnSend      = document.getElementById('btn-send');
    const sendStatus   = document.getElementById('sendStatus');

    let currentEmail = '';

    // 1. G√©n√©rer adresse jetable
    btnGen.addEventListener('click', async () => {
      btnGen.disabled = true;
      emailDisplay.textContent = 'G√©n√©ration‚Ä¶';
      try {
        const local = Math.random().toString(36).slice(2,10);
        currentEmail = `${local}@${MAILSAC_DOMAIN}`;
        emailDisplay.textContent = currentEmail;
        fromInput.value = currentEmail;
        btnCopy.disabled = false;
        btnSend.disabled = false;
        await loadMessages();
      } catch (err) {
        emailDisplay.textContent = 'Erreur üòï';
        console.error(err);
      } finally {
        btnGen.disabled = false;
      }
    });

    // 2. Copier l'adresse
    btnCopy.addEventListener('click', () => {
      navigator.clipboard.writeText(currentEmail)
        .then(() => alert('Adresse copi√©e‚ÄØ!'))
        .catch(console.error);
    });

    // 3. Charger & afficher messages
    async function loadMessages() {
      messagesDiv.innerHTML = '<p>Chargement des messages‚Ä¶</p>';
      try {
        const res = await fetch(
          `https://mailsac.com/api/addresses/${currentEmail}/messages`,
          { headers: { 'Mailsac-Key': MAILSAC_KEY } }
        );
        const list = await res.json();
        renderMessages(list);
      } catch (err) {
        messagesDiv.innerHTML = `<p>Erreur : ${err.message}</p>`;
      }
    }

    function renderMessages(list) {
      if (!list.length) {
        messagesDiv.innerHTML = '<p>Aucun message pour l‚Äôinstant.</p>';
        return;
      }
      messagesDiv.innerHTML = '';
      list.forEach(msg => {
        const box = document.createElement('div');
        box.className = 'message';
        box.innerHTML = `
          <p><strong>De :</strong> ${msg.from}</p>
          <p><strong>Sujet :</strong> ${msg.subject}</p>
          <button data-id="${msg._id}">Lire</button>
          <div id="body-${msg._id}"></div>
        `;
        box.querySelector('button').addEventListener('click', () => readMessage(msg._id));
        messagesDiv.appendChild(box);
      });
    }

    async function readMessage(id) {
      const container = document.getElementById(`body-${id}`);
      container.innerHTML = '<p>Chargement‚Ä¶</p>';
      try {
        const res = await fetch(
          `https://mailsac.com/api/text/${currentEmail}/${id}`,
          { headers: { 'Mailsac-Key': MAILSAC_KEY } }
        );
        const text = await res.text();
        container.innerHTML = `<pre>${text}</pre>`;
      } catch (err) {
        container.innerHTML = `<p>Erreur : ${err.message}</p>`;
      }
    }

    // 4. Envoyer email via Mail Sender
    btnSend.addEventListener('click', async () => {
      const to    = toInput.value.trim();
      const subj  = subjectInput.value.trim();
      const body  = bodyInput.value.trim();
      if (!currentEmail || !to || !subj || !body) {
        sendStatus.textContent = 'Merci de remplir tous les champs.';
        return;
      }
      btnSend.disabled = true;
      sendStatus.textContent = 'Envoi en cours‚Ä¶';

      try {
        const payload = {
          sendto:  to,
          name:    currentEmail,
          replyTo: currentEmail,
          ishtml:  'false',
          title:   subj,
          body:    body
        };

        const res = await fetch(`https://${MAIL_SENDER_HOST}/`, {
          method: 'POST',
          headers: {
            'Content-Type':    'application/json',
            'x-rapidapi-host': MAIL_SENDER_HOST,
            'x-rapidapi-key':  MAIL_SENDER_KEY
          },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        console.log('Mail Sender response ‚Üí', result);

        if (result.success || result.id) {
          sendStatus.textContent = '‚úÖ Email envoy√© !';
          toInput.value = '';
          subjectInput.value = '';
          bodyInput.value = '';
        } else {
          const errMsg = result.errorMessage || JSON.stringify(result);
          sendStatus.textContent = `‚ùå √âchec : ${errMsg}`;
          console.error('Erreur d√©taill√©e ‚Üí', result);
        }
      } catch (err) {
        sendStatus.textContent = '‚ùå Erreur r√©seau : ' + err.message;
        console.error(err);
      } finally {
        btnSend.disabled = false;
      }
    });

    // G√©n√©ration automatique au chargement
    btnGen.click();
  })();
  </script>
</body>
</html>